import os
import numpy as np
from PIL import Image
from torch.utils.data import Dataset, DataLoader
from torchvision import transforms

label_dict = {'的': 0, '一': 1, '是': 2, '在': 3, '不': 4, '了': 5, '有': 6, '和': 7, '人': 8, '这': 9, '中': 10,
              '大': 11, '为': 12, '上': 13, '个': 14, '国': 15, '我': 16, '以': 17, '要': 18, '他': 19, '时': 20,
              '来': 21, '用': 22, '们': 23, '生': 24, '到': 25, '作': 26, '地': 27, '于': 28, '出': 29, '就': 30,
              '分': 31, '对': 32, '成': 33, '会': 34, '可': 35, '主': 36, '发': 37, '年': 38, '动': 39, '同': 40,
              '工': 41, '也': 42, '能': 43, '下': 44, '过': 45, '子': 46, '说': 47, '产': 48, '种': 49, '面': 50,
              '而': 51, '方': 52, '后': 53, '多': 54, '定': 55, '行': 56, '学': 57, '法': 58, '所': 59, '民': 60,
              '得': 61, '经': 62, '十': 63, '三': 64, '之': 65, '进': 66, '着': 67, '等': 68, '部': 69, '度': 70,
              '家': 71, '电': 72, '力': 73, '里': 74, '如': 75, '水': 76, '化': 77, '高': 78, '自': 79, '二': 80,
              '理': 81, '起': 82, '小': 83, '物': 84, '现': 85, '实': 86, '加': 87, '量': 88, '都': 89, '两': 90,
              '体': 91, '制': 92, '机': 93, '当': 94, '使': 95, '点': 96, '从': 97, '业': 98, '本': 99, '去': 100,
              '把': 101, '性': 102, '好': 103, '应': 104, '开': 105, '它': 106, '合': 107, '还': 108, '因': 109,
              '由': 110, '其': 111, '些': 112, '然': 113, '前': 114, '外': 115, '天': 116, '政': 117, '四': 118,
              '日': 119, '那': 120, '社': 121, '义': 122, '事': 123, '平': 124, '形': 125, '相': 126, '全': 127,
              '表': 128, '间': 129, '样': 130, '与': 131, '关': 132, '各': 133, '重': 134, '新': 135, '线': 136,
              '内': 137, '数': 138, '正': 139, '心': 140, '反': 141, '你': 142, '明': 143, '看': 144, '原': 145,
              '又': 146, '么': 147, '利': 148, '比': 149, '或': 150, '但': 151, '质': 152, '气': 153, '第': 154,
              '向': 155, '道': 156, '命': 157, '此': 158, '变': 159, '条': 160, '只': 161, '没': 162, '结': 163,
              '解': 164, '问': 165, '意': 166, '建': 167, '月': 168, '公': 169, '无': 170, '系': 171, '军': 172,
              '很': 173, '情': 174, '者': 175, '最': 176, '立': 177, '代': 178, '想': 179, '已': 180, '通': 181,
              '并': 182, '提': 183, '直': 184, '题': 185, '党': 186, '程': 187, '展': 188, '五': 189, '果': 190,
              '料': 191, '象': 192, '员': 193, '革': 194, '位': 195, '入': 196, '常': 197, '文': 198, '总': 199,
              '次': 200, '品': 201, '式': 202, '活': 203, '设': 204, '及': 205, '管': 206, '特': 207, '件': 208,
              '长': 209, '求': 210, '老': 211, '头': 212, '基': 213, '资': 214, '边': 215, '流': 216, '路': 217,
              '级': 218, '少': 219, '图': 220, '山': 221, '统': 222, '接': 223, '知': 224, '较': 225, '将': 226,
              '组': 227, '见': 228, '计': 229, '别': 230, '她': 231, '手': 232, '角': 233, '期': 234, '根': 235,
              '论': 236, '运': 237, '农': 238, '指': 239, '几': 240, '九': 241, '区': 242, '强': 243, '放': 244,
              '决': 245, '西': 246, '被': 247, '干': 248, '做': 249, '必': 250, '战': 251, '先': 252, '回': 253,
              '则': 254, '任': 255, '取': 256, '据': 257, '处': 258, '队': 259, '南': 260, '给': 261, '色': 262,
              '光': 263, '门': 264, '即': 265, '保': 266, '治': 267, '北': 268, '造': 269, '百': 270, '规': 271,
              '热': 272, '领': 273, '七': 274, '海': 275, '口': 276, '东': 277, '导': 278, '器': 279, '压': 280,
              '志': 281, '世': 282, '金': 283, '增': 284, '争': 285, '济': 286, '阶': 287, '油': 288, '思': 289,
              '术': 290, '极': 291, '交': 292, '受': 293, '联': 294, '什': 295, '认': 296, '六': 297, '共': 298,
              '权': 299, '收': 300, '证': 301, '改': 302, '清': 303, '美': 304, '再': 305, '采': 306, '转': 307,
              '更': 308, '单': 309, '风': 310, '切': 311, '打': 312, '白': 313, '教': 314, '速': 315, '花': 316,
              '带': 317, '安': 318, '场': 319, '身': 320, '车': 321, '例': 322, '真': 323, '务': 324, '具': 325,
              '万': 326, '每': 327, '目': 328, '至': 329, '达': 330, '走': 331, '积': 332, '示': 333, '议': 334,
              '声': 335, '报': 336, '斗': 337, '完': 338, '类': 339, '八': 340, '离': 341, '华': 342, '名': 343,
              '确': 344, '才': 345, '科': 346, '张': 347, '信': 348, '马': 349, '节': 350, '话': 351, '米': 352,
              '整': 353, '空': 354, '元': 355, '况': 356, '今': 357, '集': 358, '温': 359, '传': 360, '土': 361,
              '许': 362, '步': 363, '群': 364, '广': 365, '石': 366, '记': 367, '需': 368, '段': 369, '研': 370,
              '界': 371, '拉': 372, '林': 373, '律': 374, '叫': 375, '且': 376, '究': 377, '观': 378, '越': 379,
              '织': 380, '装': 381, '影': 382, '算': 383, '低': 384, '持': 385, '音': 386, '众': 387, '书': 388,
              '布': 389, '复': 390, '容': 391, '儿': 392, '须': 393, '际': 394, '商': 395, '非': 396, '验': 397,
              '连': 398, '断': 399, '深': 400, '难': 401, '近': 402, '短': 403, '判': 404, '突': 405, '素': 406,
              '育': 407, '调': 408, '房': 409, '屋': 410, '易': 411, '精': 412, '负': 413, '责': 414, '言': 415,
              '退': 416, '摆': 417, '官': 418, '吵': 419, '痛': 420, '注': 421, '排': 422, '供': 423, '河': 424,
              '态': 425, '封': 426, '古': 427, '往': 428, '迈': 429, '般': 430, '候': 431, '逐': 432, '浓': 433,
              '芳': 434, '慢': 435, '随': 436, '燥': 437, '赞': 438, '露': 439, '森': 440, '句': 441, '柴': 442,
              '翻': 443, '墙': 444, '足': 445, '颜': 446, '值': 447, '号': 448, '喝': 449, '敢': 450, '跳': 451,
              '妇': 452, '找': 453, '飞': 454, '哪': 455, '玉': 456, '脸': 457, '懂': 458, '孩': 459, '帮': 460,
              '紧': 461, '状': 462, '脱': 463, '买': 464, '草': 465, '独': 466, '针': 467, '绝': 468, '细': 469,
              '详': 470, '睡': 471, '破': 472, '纪': 473, '震': 474, '穿': 475, '疼': 476, '藏': 477, '降': 478,
              '盛': 479, '怒': 480, '照': 481, '遇': 482, '底': 483, '抓': 484, '警': 485, '沉': 486, '括': 487,
              '暗': 488, '害': 489, '咳': 490, '赚': 491, '泪': 492, '剧': 493, '补': 494, '牛': 495, '骗': 496,
              '凭': 497, '劳': 498, '落': 499, '盖': 500, '销': 501, '韦': 502, '码': 503, '梦': 504, '伙': 505,
              '财': 506, '圆': 507, '险': 508, '惨': 509, '魔': 510, '测': 511, '香': 512, '踏': 513, '卷': 514,
              '块': 515, '拒': 516, '忠': 517, '郎': 518, '抱': 519, '骂': 520, '辞': 521, '园': 522, '训': 523,
              '败': 524, '姐': 525, '糖': 526, '川': 527, '旅': 528, '饭': 529, '盘': 530, '坦': 531, '牌': 532,
              '秀': 533, '卧': 534, '醒': 535, '羽': 536, '毁': 537, '懒': 538, '伯': 539, '喊': 540, '肉': 541,
              '幸': 542, '卫': 543, '析': 544, '甲': 545, '旁': 546, '练': 547, '念': 548, '仙': 549, '腰': 550,
              '席': 551, '窗': 552, '霜': 553, '掉': 554, '弹': 555, '剂': 556, '丝': 557, '喂': 558, '洞': 559,
              '掌': 560, '姓': 561, '敬': 562, '哭': 563, '悟': 564, '渐': 565, '豆': 566, '烧': 567, '磨': 568,
              '著': 569, '姑': 570, '枝': 571, '浅': 572, '紫': 573, '锁': 574, '唯': 575, '咬': 576, '忙': 577,
              '船': 578, '措': 579, '贵': 580, '避': 581, '仁': 582, '废': 583, '贯': 584, '盐': 585, '朵': 586,
              '馆': 587, '渔': 588, '惯': 589, '坐': 590, '翼': 591, '恢': 592, '减': 593, '康': 594, '裹': 595,
              '枯': 596, '折': 597, '胞': 598, '饰': 599, '薄': 600, '蒸': 601, '怜': 602, '扇': 603, '摸': 604,
              '屈': 605, '郁': 606, '跨': 607, '撒': 608, '狠': 609, '鼠': 610, '挣': 611, '泉': 612, '偿': 613,
              '愁': 614, '占': 615, '炸': 616, '哩': 617, '盆': 618, '麻': 619, '辣': 620}
label_map = {}


class CustomDataset(Dataset):
    def __init__(self, data_dir, mode):
        self.data_dir = data_dir
        self.mode = mode
        self.img_files = []
        self.labels = []
        # self.label_map = {}  # 用于将标签映射到数字
        self.transform = transforms.Compose([
            transforms.Resize((28, 28)),
            transforms.ToTensor(),
            transforms.Normalize(mean=[0.5], std=[0.5])
        ])

        if self.mode == 'train':
            self.data_dir = os.path.join(self.data_dir, 'train')
        elif self.mode == 'val':
            self.data_dir = os.path.join(self.data_dir, 'val')
        else:
            self.data_dir = os.path.join(self.data_dir, 'test')

        label_idx = 0
        for label in os.listdir(self.data_dir):
            if label not in label_map:
                label_map[label] = label_idx
                label_idx += 1
            label_dir = os.path.join(self.data_dir, label)
            for img_file in os.listdir(label_dir):
                self.img_files.append(os.path.join(label_dir, img_file))
                self.labels.append(label_map[label])

    def __len__(self):
        return len(self.img_files)

    def __getitem__(self, index):
        img_file = self.img_files[index]
        label = self.labels[index]
        img = Image.open(img_file).convert('L')
        img = self.transform(img)
        return img, label


def GetLabelMap():
    return label_map
